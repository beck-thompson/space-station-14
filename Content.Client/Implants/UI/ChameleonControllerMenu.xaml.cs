using System.Numerics;
using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared.Roles;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Timing;

namespace Content.Client.Implants.UI;

[GenerateTypedNameReferences]
public sealed partial class ChameleonControllerMenu : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
    [Dependency] private readonly IEntityManager _entityManager = default!;
    private readonly SpriteSystem _sprite;

    // List of all the job protos that you can select!
    private IEnumerable<JobPrototype> _jobPrototypes = [];

    // Lock the UI until this time
    public DateTime? _lockedUntil;

    public event Action<ProtoId<JobPrototype>>? OnJobSelected;

    public ChameleonControllerMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _sprite = _entityManager.System<SpriteSystem>();
    }

    public void UpdateState(IEnumerable<JobPrototype> jobs)
    {
        _jobPrototypes = jobs;
        UpdateGrid();
    }

    /// <summary>
    ///     Fill the grid with the correct job icons and buttons.
    /// </summary>
    /// <param name="disabled">Set to true to disable all the buttons.</param>
    public void UpdateGrid(bool disabled = false)
    {
        Grid.RemoveAllChildren();

        foreach (var job in _jobPrototypes)
        {
            if (!_prototypeManager.TryIndex(job.Icon, out var jobIconProto))
                continue;

            var boxContainer = new BoxContainer();

            var button = new Button
            {
                HorizontalExpand = true,
                StyleClasses = {StyleBase.ButtonSquare},
                ToolTip = Loc.GetString(job.Name),
                Text = Loc.GetString(job.Name),
                Margin = new Thickness(0, 0, 15, 0),
                Disabled = disabled,
            };

            var jobIconTexture = new TextureRect
            {
                Texture = _sprite.Frame0(jobIconProto.Icon),
                TextureScale = new Vector2(2.5f, 2.5f),
                Stretch = TextureRect.StretchMode.KeepCentered,
                Margin = new Thickness(0, 0, 5, 0),
            };

            boxContainer.AddChild(jobIconTexture);
            boxContainer.AddChild(button);

            button.OnPressed += _ => JobButtonPressed(job);

            Grid.AddChild(boxContainer);
        }
    }

    private void JobButtonPressed(ProtoId<JobPrototype> job)
    {
        OnJobSelected?.Invoke(job);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        if (_lockedUntil == null || DateTime.Now < _lockedUntil)
            return;

        _lockedUntil = null;
        UpdateGrid();
    }
}
